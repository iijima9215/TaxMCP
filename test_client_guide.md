# 日本税務計算MCPサーバー テストクライアント ガイド

## 概要

`test_client.py`は、日本税務計算MCPサーバーの機能をテストするためのクライアントアプリケーションです。このクライアントは、MCPサーバーの各種税務計算機能を検証し、動作確認を行うためのツールとして設計されています。

## 主な機能

### 1. TaxMCPClientクラス

メインのクライアントクラスで、以下の機能を提供します：

#### ヘルスチェック機能
- `health_check()`: サーバーの基本的な動作確認
- `test_tax_calculator_import()`: 税計算モジュールのインポートテスト

#### 税務計算機能のシミュレーション
- `call_tool()`: MCPサーバーの各種ツールをシミュレート
- 所得税計算、消費税率取得、住民税計算、複数年シミュレーションなどをサポート

### 2. テスト対象機能

#### 所得税計算テスト (`test_income_tax_calculation`)
- **低所得者**: 年収300万円のケース
- **中所得者**: 年収600万円、扶養家族2人のケース
- **高所得者**: 年収1000万円のケース

各テストケースで以下の情報を表示：
- 年収
- 課税所得
- 所得税額
- 実効税率
- 限界税率

#### 消費税率取得テスト (`test_consumption_tax_rate`)
- 標準税率と軽減税率の取得
- 異なる日付での税率変更の確認
- 2019年10月の税率改正前後の比較

#### 住民税計算テスト (`test_resident_tax_calculation`)
- 東京都と大阪府での計算例
- 都道府県民税と市区町村民税の内訳表示
- 所得割と均等割の計算

#### 複数年シミュレーションテスト (`test_multi_year_simulation`)
- 5年間の年収変動シミュレーション（400万円〜800万円）
- 年別の税額と実効税率の推移
- 期間全体の総収入、総税額、平均実効税率

#### ユーティリティ機能テスト (`test_utility_functions`)
- サポート都道府県一覧の取得（全47都道府県）
- 税制年度情報の取得（2020-2025年度対応）
- 利用可能機能の一覧表示

## 使用方法

### 基本的な実行

```bash
python test_client.py
```

### 個別テストの実行

```python
from test_client import TaxMCPClient

client = TaxMCPClient()

# 所得税計算のみテスト
client.test_income_tax_calculation()

# 住民税計算のみテスト
client.test_resident_tax_calculation()

# 全テスト実行
client.run_all_tests()
```

### カスタムテストケースの作成

```python
# 独自の所得税計算テスト
result = client.call_tool("calculate_income_tax", {
    "annual_income": 5000000,  # 年収500万円
    "dependents_count": 1,     # 扶養家族1人
    "spouse_deduction": 380000 # 配偶者控除
})

print(f"所得税: {result['income_tax']:,}円")
print(f"実効税率: {result['effective_rate']}%")
```

## 出力例

### 所得税計算テスト結果
```
=== Testing Income Tax Calculation ===

低所得者（年収300万円）:
  年収: 3,000,000円
  課税所得: 2,070,000円
  所得税: 103,500円
  実効税率: 3.45%
  限界税率: 5%
```

### 複数年シミュレーション結果
```
=== Testing Multi-Year Tax Simulation ===

シミュレーション概要:
  期間: 2024年 - 2028年
  総収入: 30,000,000円
  総税額: 3,490,500円
  平均実効税率: 11.64%

年別詳細:
  2024年: 年収4,000,000円 → 税額424,500円 (実効税率10.61%)
  2025年: 年収5,000,000円 → 税額509,500円 (実効税率10.19%)
  ...
```

## 注意事項

### シミュレーション機能について
- このテストクライアントは、実際のMCPサーバーとの通信ではなく、**シミュレーション機能**を使用しています
- 実際の税額計算は簡易版であり、正確な税務計算には実際のMCPサーバーを使用してください

### 対応年度
- 2020年度〜2025年度の税制に対応
- デフォルトは2025年度の税制を使用

### サポート地域
- 全47都道府県に対応
- 各都道府県の住民税率を考慮した計算

## トラブルシューティング

### よくある問題

1. **モジュールインポートエラー**
   ```
   ✗ Tax calculator module test failed
   ```
   → `tax_calculator.py`が正しく配置されているか確認

2. **計算結果の相違**
   → シミュレーション機能は簡易計算のため、実際のサーバーと結果が異なる場合があります

3. **年度エラー**
   → サポート年度（2020-2025）の範囲内で指定してください

## 開発者向け情報

### クラス構造
```
TaxMCPClient
├── health_check()                    # ヘルスチェック
├── call_tool()                       # ツール呼び出し
├── _simulate_income_tax()            # 所得税計算シミュレーション
├── _simulate_consumption_tax_rate()  # 消費税率シミュレーション
├── _simulate_resident_tax()          # 住民税計算シミュレーション
├── _simulate_multi_year_taxes()      # 複数年シミュレーション
├── _get_supported_prefectures()     # 都道府県一覧
└── _get_tax_year_info()             # 年度情報
```

### 拡張方法
新しいテストケースを追加する場合：

1. `call_tool()`メソッドに新しいメソッド名を追加
2. 対応するシミュレーション関数を実装
3. テスト関数を作成
4. `run_all_tests()`に追加

## ライセンス

このテストクライアントは、日本税務計算MCPサーバープロジェクトの一部として提供されています。