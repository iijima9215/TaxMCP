**税務 MCP 開発ガイド**

**独自の MCP（Model Context Protocol）を開発し、税務関連の最新情報に対応した正確な税務処理金額を算出し、複数年や数十通りのシミュレーションに対応させることは、MCP の強力な機能と設計原則を活用することで実現可能です。MCP は、AI システムが外部のツールやデータと安全かつ予測可能に連携するための基盤を提供します**。

**以下に、独自の税務 MCP を開発するためのステップ・バイ・ステップの解説を示します。**

**1. MCP の核となる概念と税務機能への応用**

**税務関連 MCP の要件を満たすために、以下の MCP の主要コンポーネントがどのように活用されるかを理解することが重要です。**

**•** **プロトコル定義 (JSON-RPC 2.0 ベース)** **: MCP は軽量で言語に依存しないリモートプロシージャコール（RPC）プロトコルである JSON-RPC 2.0 を基盤としており、明確に定義された入力と出力を持つ予測可能なリクエスト/レスポンス構造を保証します**。これにより、税務計算のリクエストと結果が標準化されます。

**•** **ツールスキーマ** **: 各税務ツール（例:** `所得税計算`, `消費税シミュレーション`）は、メソッド名、パラメータ（型と制約を含む）、人間が読める説明などを記述した構造化された JSON スキーマから開始します**。これにより、LLM やエージェントはアクションについて信頼性高く推論し、複雑な税務ワークフローを構成できます。**

**•** **コンテキストブロック** **: 各リクエストに渡されるオプションのメタデータで、ユーザー ID、セッション ID、または特定の税務シミュレーション条件（例: 複数年の計算に必要な年度範囲、特定の条例適用フラグ）などのメタデータを含めることができます**。

**•** **ツールサーバー** **: HTTP POST エンドポイントであり、JSON-RPC 2.0 ペイロードを受け入れ、税務計算リクエストを処理し、構造化された結果を返します。これはエージェントスタックの実行レイヤーとして機能します**。

**•** **レジストリ（推奨）** **: 税務ツールの発見可能なインデックスです。これにより、利用可能な税務計算機能が体系的に管理されます**。

**•** **トランスポート** **: HTTP を介した JSON-RPC がデフォルトですが、Server-Sent Events (SSE)や WebSocket、stdio なども利用可能です**。

**2. ステップ・バイ・ステップの税務 MCP 開発手順**

**ステップ 1: 環境構築と SDK の選択**

**まず、開発環境をセットアップし、\*\***Python (FastAPI, FastMCP)\*\* **または** **TypeScript (** **@modelcontextprotocol/sdk** **)** **のいずれかのプログラミング言語と対応する SDK を選択します**。これらは、MCP サーバーとクライアントを迅速に構築するためのフレームワークやライブラリを提供します。

**ステップ 2: 税務ツールのスキーマ定義**

**このステップは、税務 MCP の核となります。各税務機能は、\*\***JSON スキーマ**を使用して、その機能、入力パラメータ、および期待される出力形式を厳密に定義する必要があります**。\*\*

**•** **メソッド名** **: 税務処理の具体的な内容を示す一意の名前（例:** `calculate_income_tax`, `simulate_consumption_tax`, `get_prefectural_tax_rate`）**。**

**•** **説明** **: LLM や人間がツールの目的を理解するための人間が読める説明**。

**•** **パラメータ** **: 各パラメータの型、制約、必須/オプションを指定します。税務情報として、以下の要素をパラメータに含めます。**

** ◦** **基本情報** **:** `income_type`, `income_amount`, `deductions`, `family_members`, `prefecture`, `city`など。

** ◦** **期間情報** **:** **fiscal_year\*\*** (複数年対応のために必須)\*\*。

** ◦** **条件情報** **:** **シミュレーション用の特定の条件** **（例:** `is_temporary_law_applied`, `ordinance_id`、控除の種類、投資の種類など）**。**

**•** **出力** **: 計算された税額、税額の内訳、適用された法令のリスト、シミュレーション結果のサマリーなど、構造化された予測可能な形式で定義します**。

**最新の税務情報（都道府県別、時限立法、条例など）との連携** **:** **税務ロジックは、常に最新の法令データにアクセスできる必要があります。これは、\*\***外部データソースとの統合**として MCP サーバー内で実現されます**。専用のデータベースや API から、以下の情報を取得・更新する仕組みを構築します。\*\*

**•** **税法データベース** **: 国税（所得税、法人税など）、地方税（住民税、固定資産税など）の最新情報。**

**•** **都道府県/市区町村ごとの条例データベース** **: 地方税の条例情報を管理。**

**•** **時限立法データベース** **: 特定の期間のみ有効な法令情報を管理。** **これらは MCP サーバーのバックエンドロジックによってクエリされ、税務計算に利用されます。**

**ステップ 3: MCP サーバーの実装**

**MCP サーバーは、定義された税務ツールをホストし、エージェントからのリクエストを処理する HTTP エンドポイントです**。

**•** **HTTP POST エンドポイントの設定** **: JSON-RPC 2.0 ペイロードを受け入れる単一の HTTP POST エンドポイント（例:** `/mcp` **または** `/rpc`）を作成します**。**

**•** **リクエストハンドリング** **:**

** ◦** **受信した JSON-RPC リクエストをパースし、\*\***JSON スキーマに基づいて入力パラメータを厳密に検証**します。税務データの正確性の確保に不可欠です**。\*\*

** ◦** **リクエストされた税務ツールのロジックを実行します。ここには、外部の税法データベースへのクエリや計算エンジンの呼び出しが含まれます。**

** ◦** **ツールの実行結果またはエラーを、標準化された JSON-RPC 形式で返します**。

** ◦** **コンテキストブロックの利用** **: 複数年の計算や数十通りのシミュレーションのために、リクエストごとに異なる条件や状態（例: 各シミュレーションの特定の税率、控除額、適用年度）をコンテキストブロックで管理し、ツールの動作をガイドします**。

**複数年対応と数十通りのシミュレーションへの対応** **:**

**•** **ツールチェイニング/オーケストレーション** **: LLM やエージェントは、個々の税務計算ツールを複数回呼び出すことで、複数年の計算や様々な条件でのシミュレーションを実行します。MCP は、このような多段階のワークフローを構築するための基盤となります**。例えば、エージェントが「過去 5 年間の所得税を異なる控除パターンでシミュレーション」という要求を受け取った場合、サーバーの `calculate_income_tax`ツールを年度と控除パターンを変えて複数回呼び出します。

**•** **サーバーサイドでの複雑なロジック** **: 十数通り程度のシミュレーションであれば、単一のツールで複雑なロジックを内包し、パラメータによって分岐させることも可能です。その場合、出力スキーマで結果を構造化し、エージェントが解析しやすいようにします。**

**ステップ 4: 税務ツールの登録と公開**

**MCP サーバーは、自身の機能（税務ツール）をエージェントに公開する必要があります。**

**•** **ツールディスカバリ** **: サーバーは、**`/tools/discover`メソッドを実装し、利用可能なツールとそのスキーマのリストを含むマニフェストを返す必要があります**。これにより、LLM クライアントは動的に税務ツールを検出できます。**

**•** **レジストリサービス（任意）** **: 複数の MCP サーバー（例: 国税用 MCP、地方税用 MCP など）がある場合、中央レジストリサービスにツールを登録することで、ツールの検出と管理が容易になります**。

**ステップ 5: セキュリティの実装**

**税務データは機密性が高いため、セキュリティは MCP ベースのアーキテクチャの\*\***最も重要な側面**であり、設計の初期段階から組み込む必要があります**。\*\*

**•** **認証と認可** **:**

** ◦** **認証** **: API キー、OAuth 2.1 (JWTs)、相互 TLS (mTLS) などのメカニズムを使用して、リクエスト元のエージェントやシステムの身元を厳格に検証します**。

** ◦** **認可** **:** **スコープ制御** **（エージェントがアクセスできる税務ツールやデータ範囲を制限する）や** **最小権限の原則** **（ツールが実行に必要な最小限のアクセスのみを持つ）を適用します**。

**•** **データサニテーションと検証** **:** **JSON スキーマ検証**を実装して、すべての RPC パラメータが予期される型と制約に準拠していることを確認し、不正なデータや悪意のあるデータを早期に捕捉します。税務計算の正確性を担保するため、これは極めて重要です**。**

**•** **脅威モデルと監査・ガバナンス** **: OWASP Threat Dragon などのツールを使用して、データフローをダイアグラム化し、改ざんやリプレイ攻撃などの潜在的な攻撃ベクトルを特定します**。すべてのツール呼び出しをログに記録し、**監査証跡**を提供することで、アカウンタビリティと追跡可能性を確保します。これは税務コンプライアンスの観点から不可欠です**。**

**ステップ 6: テスト、デバッグ、デプロイ**

**強固な税務 MCP システムを構築するには、厳格なテスト、効果的なデバッグ、および堅牢なデプロイ戦略が必要です**。

**•** **ユニットテストと統合テスト** **: pytest などのフレームワークを使用して個々の税務計算ハンドラを分離して検証し、Docker Compose などでリアルなバックエンド（例: 税法データベースのモック）を持つ統合テストでエンドツーエンドのワークフローを確認します**。

**•** **ロギングとモニタリング** **: JSON-RPC リクエストとレスポンスペイロードの詳細なログを記録し、Prometheus や Grafana などのツールでメトリクス（税務計算時間、エラー率、スループットなど）を監視することで、パフォーマンスのボトルネックを特定し、問題を迅速に解決します**。

**•** **パフォーマンス最適化** **:**

** ◦** **ステートレスデザイン** **: 各リクエストがすべての情報を含むステートレスサービスとしてツールを設計します**。

** ◦** **キャッシング** **: 頻繁にアクセスされる（しかし変更頻度の低い）税率や共通控除額などのデータをサーバーサイドでキャッシュし、バックエンドシステムへの負荷を軽減します**。

** ◦** **負荷分散** **: 複数の MCP サーバーインスタンス間で JSON-RPC リクエストを分散するために、HTTP ロードバランサーやサービスメッシュを利用します。特にシミュレーションで大量のリクエストが発生する場合に重要です**。

**•** **CI/CD パイプラインとコンテナ化** **: GitHub Actions などの CI/CD ツールを使用して、テストを自動化し、Docker コンテナや Kubernetes などのオーケストレーションプラットフォームにデプロイすることで、一貫性と再現性を確保します**。

**これらのステップと考慮事項に従うことで、独自の税務 MCP サーバーを効果的に設計、実装、デプロイし、AI システムを外部の最新税務情報と安全かつ予測可能に連携させることが可能になります。MCP は、AI との統合における柔軟性、効率性、明確性を提供し、インテリジェントで拡張性の高い税務エージェントシステムを構築するための基盤となります。**
